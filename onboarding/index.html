<div id="main"></div>
<script>
  // constrants
  const RESOURCE_ID = 6626;
  let currentEntryId = null;

  // Utility function to show/hide elements
  function toggleVisibility(element, shouldShow) {
    element.style.display = shouldShow ? "block" : "none";
  }

  function setDisabledProperty(obj, isViewMode) {
    for (const key in obj) {
      if (obj.hasOwnProperty(key)) {
        if (key === "disabled") {
          obj[key] = isViewMode;
        } else if (typeof obj[key] === "object" && obj[key] !== null) {
          setDisabledProperty(obj[key]);
        }
      }
    }
  }

  function clickTab(tabId) {
    const tabElement = document.querySelector(`span[tab-id="${tabId}"]`);
    if (tabElement) {
      tabElement.click();
    } else {
      console.log(`Tab with ID "${tabId}" not found.`);
    }
  }

  function refreshGridData() {
    const grid = $("#gridContainer").data("KendoGrid");
    if (grid) grid.dataSource.read();
    console.warn(grid);
  }

  // Handle business type selection change
  function handleBusinessTypeChange() {
    const otherField = document.querySelector(
      'input[data-name="OtherBusinessType"]'
    );
    const selectField = document.querySelector(
      'select[data-name="BusinessType"]'
    );
    const otherElement = otherField.parentElement.parentElement;

    if (selectField.value === "Other") {
      toggleVisibility(otherElement, true);
    } else {
      toggleVisibility(otherElement, false);
    }
  }

  // Handle countries selection change
  function handleCountriesChange() {
    const otherCountryField = document.querySelector(
      'input[data-name="OtherCountry"]'
    );
    const otherCountryElement = otherCountryField.parentElement.parentElement;

    if (
      form.config.dataset.SelectedCountries &&
      form.config.dataset.SelectedCountries.includes("Other")
    ) {
      toggleVisibility(otherCountryElement, true);
    } else {
      toggleVisibility(otherCountryElement, false);
    }
  }

  // Function to populate form with data for editing
  function populateFormForEdit(dataItem) {
    Object.keys(dataItem).forEach((key) => {
      form.config.dataset[key] = dataItem[key];
    });

    currentEntryId = dataItem.EntryId;

    clickTab("Form");

    nbsf.init(form.config, form.config.page);
  }

  // Function to populate form with data for view
  function populateFormForView(dataItem) {
    // Object.keys(dataItem).forEach((key) => {
    //   form.config.dataset[key] = dataItem[key]; // Populate the dataset
    // });

    const modalContent = `
    <div>
      <div id="viewTabs"></div>
    </div>
  `;

    // Show the modal using your overlay utility
    mo.fn.modal.show({
      title: "View Details",
      content: modalContent,
      ctaLabel: "Close",
      close: true,
    });

    hpe.ui.tabs(
      {
        dom: document.querySelector("#viewTabs"),
        tabs: [
          {
            label: "Agreement",
            id: "First",
          },
          {
            label: "Company Information",
            id: "Second",
          },
          {
            label: "Select date & country",
            id: "Third",
          },
        ],
      },
      function (all) {
        const firstTab = all[0];
        const secondTab = all[1];
        const thirdTab = all[2];

        const viewForm = form;
        // disabled: true in form object
        setDisabledProperty(form.config, true);

        firstTab.innerHTML = '<div id="firstTab"></div>';
        form.config.dom = firstTab.querySelector("#firstTab");
        form.config.pages[0].nav = false;
        form.config.pages[0].disabled = true;
        nbsf.init(form.config, 0);

        secondTab.innerHTML = '<div id="secondTab"></div>';
        form.config.dom = secondTab.querySelector("#secondTab");

        nbsf.init(form.config, 1);

        thirdTab.innerHTML = '<div id="thirdTab"></div>';
        form.config.dom = thirdTab.querySelector("#thirdTab");
        form.config.pages[2].nav = false;
        nbsf.init(form.config, 2);
      }
    );
  }

  // Prepare the dataset for submission
  function prepareFormData() {
    const datasetForSubmit = {
      BusinessType: form.config.dataset.BusinessType || "",
      OtherBusinessType: form.config.dataset.OtherBusinessType || "",
      OtherCountry: form.config.dataset.OtherCountry || "",
      SelectedCountries: form.config.dataset.SelectedCountries || "",
      SelectedDateTime: form.config.dataset.SelectedDateTime || "",
      UserAgreementStatus: form.config.dataset.UserAgreementStatus || "N",
      UserEmail: form.config.dataset.UserEmail || "",
      UserSelectedOption: form.config.dataset.UserSelectedOption || "No",
    };

    if (datasetForSubmit.SelectedCountries.includes("Other")) {
      let countriesArray = datasetForSubmit.SelectedCountries.split(",");
      countriesArray = countriesArray.filter((country) => country !== "Other");
      datasetForSubmit.SelectedCountries = countriesArray.join(",");
    }

    return datasetForSubmit;
  }

  async function createEntry(dataset) {
    return new Promise((resolve, reject) => {
      crud.create(RESOURCE_ID, dataset, function (res) {
        if (res) resolve(res);
        else reject(new Error("Creation failed"));
      });
    });
  }

  async function updateEntry(entryId, dataset) {
    return new Promise((resolve, reject) => {
      crud.update(RESOURCE_ID, entryId, dataset, function (res) {
        if (res) resolve(res);
        else reject(new Error("Update failed"));
      });
    });
  }

  async function deleteEntry(entryId) {
    return new Promise((resolve, reject) => {
      crud.destroy(RESOURCE_ID, entryId, function (res) {
        if (res) resolve(res);
        else reject(new Error("Deletion failed"));
      });
    });
  }

  function showSuccessModal(message) {
    mo.fn.modal.show({
      title: "Success",
      content: message,
      ctaLabel: "Close",
      ctaCallback: mo.fn.modal.hide,
    });
  }

  function showErrorModal(message) {
    mo.fn.modal.show({
      title: "Error",
      content: message,
      ctaLabel: "Close",
      ctaCallback: mo.fn.modal.hide,
    });
  }

  function openDeleteConfirmationModal(entryId) {
    mo.fn.modal.show({
      title: "Confirm Deletion",
      content: "Are you sure you want to delete the record?",
      ctaLabel: "Yes",
      ctaCallback: async () => {
        try {
          await deleteEntry(entryId);
          showSuccessModal("Record deleted successfully.");
        } catch (error) {
          showErrorModal("Failed to delete the record. Please try again.");
        } finally {
          mo.fn.modal.hide();
          refreshGridData(); // Refresh the grid data after deletion
        }
      },
      close: true,
      closeLabel: "No",
    });
  }

  // Handle form submission
  async function submitForm() {
    try {
      const datasetForSubmit = prepareFormData();
      mo.fn.overlay.show({ loading: true });

      const response =
        currentEntryId === null
          ? await createEntry(datasetForSubmit)
          : await updateEntry(currentEntryId, datasetForSubmit);

      mo.fn.overlay.hide();
      showSuccessModal("Your form has been successfully submitted!");

      if (currentEntryId !== null) {
        clickTab("Grid");
        currentEntryId = null;
        refreshGridData();
      }
    } catch (error) {
      mo.fn.overlay.hide();
      showErrorModal("Failed to submit the form. Please try again.");
      console.error(error);
    }
  }

  function initializeGrid(gridContainer) {
    const dataSource = new kendo.data.DataSource({
      type: "rfb-v2",
      transport: {
        read: {
          url: "/form/data-set-provider/v2/1884/Robert_Test/kendo/data/search",
          type: "POST",
        },
        create: {
          url: "/form/data-set-provider/v2/1884/Robert_Test/kendo/data",
          dataType: "json",
          type: "POST",
        },
        update: {
          url: "/form/data-set-provider/v2/1884/Robert_Test/kendo/data",
          dataType: "json",
          type: "PUT",
        },
        destroy: {
          url: "/form/data-set-provider/v2/1884/Robert_Test/kendo/data",
          dataType: "json",
          type: "DELETE",
        },
      },
      schema: {
        model: {
          id: "EntryId",
          fields: {
            EntryId: { type: "number", editable: false },
            Created: { type: "date", editable: false },
            BusinessType: { type: "string" },
            OtherBusinessType: { type: "string" },
            SelectedCountries: { type: "string" },
            OtherCountry: { type: "string" },
            SelectedDateTime: { type: "date" },
          },
        },
      },
      serverPaging: true,
      pageSize: 15,
      serverFiltering: true,
      serverSorting: true,
      size: "small",
      sort: { field: "EntryId", dir: "desc" },
    });

    console.log("this is datasource", dataSource);

    // Initialize the Kendo Grid
    $(gridContainer).kendoGrid({
      dataSource: dataSource,
      filterable: true,
      sortable: true,
      editable: "incell",
      resizable: true,
      reorderable: true,
      pageable: {
        refresh: true,
        pageSizes: true,
        buttonCount: 5,
      },
      groupable: true,
      toolbar: ["create", "excel"],
      excel: {
        fileName: "Kendo UI Grid Export.xlsx",
        proxyURL: "https://demos.telerik.com/kendo-ui/service/export",
        filterable: true,
      },
      columns: [
        { field: "EntryId", title: "EntryId", locked: true, width: "100px" },
        {
          field: "Created",
          title: "Created Date",
          format: "{0:MM/dd/yyyy}",
          locked: true,
          filterable: {
            ui: "datepicker",
          },
          width: "150px",
        },
        {
          field: "BusinessType",
          title: "Company Business Type",
          template: function (dataItem) {
            return dataItem.BusinessType === "Other"
              ? `Other: ${dataItem.OtherBusinessType}`
              : dataItem.BusinessType;
          },
          width: "200px",
        },
        {
          field: "SelectedCountries",
          title: "Countries",
          template: function (dataItem) {
            let countries = dataItem.SelectedCountries;
            if (dataItem.OtherCountry) {
              countries += `, ${dataItem.OtherCountry}`;
            }
            return countries;
          },
          width: "250px",
        },
        {
          field: "SelectedDateTime",
          title: "Datetime",
          format: "{0:MM/dd/yyyy hh:mm tt}",
          width: "200px",
        },
        {
          command: [
            {
              name: "editButton",
              text: "Edit",
              click: function (e) {
                const dataItem = this.dataItem(
                  $(e.currentTarget).closest("tr")
                );
                populateFormForEdit(dataItem);
              },
            },
            {
              name: "deleteButton",
              text: "Delete",
              click: function (e) {
                const dataItem = this.dataItem(
                  $(e.currentTarget).closest("tr")
                );
                openDeleteConfirmationModal(dataItem.EntryId);
              },
            },
            {
              name: "view",
              text: "View",
              click: function (e) {
                const dataItem = this.dataItem(
                  $(e.currentTarget).closest("tr")
                );
                populateFormForView(dataItem); // Call function to populate and open modal
              },
            },
          ],
          title: "&nbsp;",
          width: "150px",
        },
      ],
      editable: "false",
      save: function (e) {
        dataSource.read();
      },
    });
  }

  const form = {
    config: {
      page: 0,
      dataset: {},
      pages: [
        // Page 1: Agreement
        {
          title: "Agreement",
          subtitle: "",
          description: "",
          nav: true,
          structure: [
            {
              header: "",
              description: "",
              group: [
                [
                  {
                    label: "Agreement Confirmed",
                    data: "UserAgreementStatus",
                    required: true,
                    type: "toggle",
                    values: ["N", "Y"],
                    disabled: false,
                  },
                ],
              ],
            },
            {
              header: "",
              description: "",
              group: [
                [
                  {
                    label: "Email:",
                    data: "UserEmail",
                    type: "email",
                    placeholder: "Please input email address",
                    validation: ["isEmail"],
                    required: true,
                    disabled: false,
                  },
                ],
              ],
            },
          ],
        },
        // Page 2: Company Information
        {
          title: "Company Information",
          subtitle: "",
          description: "",
          nav: true,
          structure: [
            {
              header: "",
              description: "",
              group: [
                [
                  {
                    type: "select",
                    data: "BusinessType",
                    label: "Company Business Type",
                    values: ["Distributor", "Reseller", "Provider", "Other"],
                    options: ["Distributor", "Reseller", "Provider", "Other"],
                    required: true,
                    disabled: false,
                    change: handleBusinessTypeChange,
                  },

                  {
                    type: "text",
                    data: "OtherBusinessType",
                    label: "Please specify if Other",
                    validation: ["minLen|1"],
                    disabled: false,
                  },
                ],
                [
                  {
                    type: "radio",
                    data: "UserSelectedOption",
                    label: "Choose",
                    values: ["Yes", "No"],
                    required: true,
                    disabled: false,
                  },
                ],
              ],
            },
          ],
          callback: handleBusinessTypeChange,
        },
        // Page 3: Date & Country Selection
        {
          title: "Select date & country",
          substitle: "",
          description: "",
          nav: true,
          structure: [
            {
              header: "",
              description: "",
              group: [
                [
                  {
                    type: "datetime",
                    data: "SelectedDateTime",
                    label: "Datetime",
                    required: true,
                    disabled: false,
                  },
                ],
                [
                  {
                    type: "multiselect",
                    data: "SelectedCountries",
                    label: "Select Countries",
                    values: [
                      "USA",
                      "Canada",
                      "Germany",
                      "France",
                      "Japan",
                      "India",
                      "China",
                      "Brazil",
                      "Australia",
                      "Mexico",
                      "Other",
                    ],
                    required: true,
                    disabled: false,
                    change: handleCountriesChange,
                  },
                  {
                    type: "text",
                    data: "OtherCountry",
                    label: "Please specify if Other",
                    validation: ["minLen|1"],
                    disabled: false,
                  },
                ],
              ],
            },
          ],
          callback: handleCountriesChange,
        },
      ],
      onSubmit: submitForm,
    },
    init: function () {
      nbsf.init(this.config, this.config.page);
    },
  };

  const formContainer = {
    config: {},
    init: function () {
      hpe.ui.tabs(
        {
          dom: document.querySelector("#main"),
          tabs: [
            {
              label: "Grid",
              id: "Grid",
            },
            {
              label: "Form",
              id: "Form",
            },
          ],
        },
        function (all) {
          const gridTab = all[0];
          const formTab = all[1];

          formTab.innerHTML = '<div id="formTab"></div>';
          form.config.dom = formTab.querySelector("#formTab");
          form.init();

          gridTab.innerHTML = '<div id="gridTab"></div>';
          initializeGrid(gridTab.querySelector("#gridTab"));
        }
      );
    },
  };

  const main = {
    init: function () {
      hpe.supplies.crud();
      hpe.supplies.mojs();
      hpe.supplies.nbsf();
      hpe.supplies.q.end(function () {
        mo.init();
        formContainer.init();
      });
    },
  };
  main.init();
</script>
