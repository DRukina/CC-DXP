<div id="main"></div>
<script>
  // constrants
  const RESOURCE_ID = 6626;
  let currentEntryId = null;

  // Utility function
  const utils = {
    toggleVisibility: (element, shouldShow) => {
      element.style.display = shouldShow ? "block" : "none";
    },
    clickTab: (tabId) => {
      const tabElement = document.querySelector(`span[tab-id="${tabId}"]`);
      if (tabElement) {
        tabElement.click();
      } else {
        console.log(`Tab with ID "${tabId}" not found.`);
      }
    },
    refreshGridData: () => {
      const grid = $("#gridTab").data("kendoGrid");
      if (grid) grid.dataSource.read();
      console.warn(grid);
    },
    formatDate: (dateString) => {
      const date = new Date(dateString);
      const padZero = (value) => String(value).padStart(2, "0");

      return `${date.getFullYear()}-${padZero(date.getMonth() + 1)}-${padZero(
        date.getDate()
      )}T${padZero(date.getHours())}:${padZero(date.getMinutes())}:${padZero(
        date.getSeconds()
      )}`;
    },
  };

  const crudOperations = {
    createEntry: (dataset) =>
      new Promise((resolve, reject) => {
        crud.create(RESOURCE_ID, dataset, function (res) {
          if (res) resolve(res);
          else reject(new Error("Creation failed"));
        });
      }),
    updateEntry: (entryId, dataset) =>
      new Promise((resolve, reject) => {
        crud.update(RESOURCE_ID, entryId, dataset, function (res) {
          if (res) resolve(res);
          else reject(new Error("Update failed"));
        });
      }),
    deleteEntry: (entryId) =>
      new Promise((resolve, reject) => {
        crud.destroy(RESOURCE_ID, entryId, function (res) {
          if (res) resolve(res);
          else reject(new Error("Deletion failed"));
        });
      }),
  };

  const modalHelpers = {
    modalWithCloseBtn: function (title, message) {
      console.log("tester");
      mo.fn.modal.show({
        title,
        content: message,
        ctaLabel: "Close",
        ctaCallback: () => {
          mo.fn.modal.hide();
        },
      });
    },
    openDeleteConfirmationModal: function (entryId) {
      console.log("this is confirm delete modal");
      mo.fn.modal.show({
        title: "Confirm Deletion",
        content: "Are you sure you want to delete the record?",
        ctaLabel: "Yes",
        ctaCallback: async () => {
          try {
            await crudOperations.deleteEntry(entryId);
            this.modalWithCloseBtn("Success", "Record deleted successfully.");
          } catch (error) {
            console.log("error occured");
            this.modalWithCloseBtn(
              "Error",
              "Failed to delete the record. Please try again."
            );
          } finally {
            // mo.fn.modal.hide();
            utils.refreshGridData();
          }
        },
        close: true,
        closeLabel: "No",
      });
    },
  };

  const formActions = {
    handleBusinessTypeChange: () => {
      const otherField = document.querySelector(
        'input[data-name="OtherBusinessType"]'
      );
      const selectField = document.querySelector(
        'select[data-name="BusinessType"]'
      );
      const otherElement = otherField.parentElement.parentElement;

      if (selectField.value === "Other") {
        utils.toggleVisibility(otherElement, true);
      } else {
        utils.toggleVisibility(otherElement, false);
      }
    },
    handleCountriesChange: () => {
      const otherCountryField = document.querySelector(
        'input[data-name="OtherCountry"]'
      );
      const otherCountryElement = otherCountryField.parentElement.parentElement;

      if (
        form.config.dataset.SelectedCountries &&
        form.config.dataset.SelectedCountries.includes("Other")
      ) {
        utils.toggleVisibility(otherCountryElement, true);
      } else {
        utils.toggleVisibility(otherCountryElement, false);
      }
    },
    submitForm: async () => {
      try {
        const datasetForSubmit = formActions.prepareFormData();
        mo.fn.overlay.show({ loading: true });

        const response =
          currentEntryId === null
            ? await crudOperations.createEntry(datasetForSubmit)
            : await crudOperations.updateEntry(
                currentEntryId,
                datasetForSubmit
              );

        mo.fn.overlay.hide();
        modalHelpers.modalWithCloseBtn(
          "Success",
          "Your form has been successfully submitted!"
        );

        // if (currentEntryId !== null) {
        utils.clickTab("Grid");
        currentEntryId = null;
        // }
        utils.refreshGridData();
      } catch (error) {
        mo.fn.overlay.hide();
        modalHelpers.modalWithCloseBtn(
          "Error",
          "Failed to submit the form. Please try again."
        );
        console.error(error);
      }
    },
    populateFormForEdit: (dataItem) => {
      Object.assign(form.config.dataset, dataItem);

      if (form.config.dataset.SelectedDateTime) {
        form.config.dataset.SelectedDateTime = utils.formatDate(
          form.config.dataset.SelectedDateTime
        );
      }
      currentEntryId = dataItem.EntryId;

      utils.clickTab("Form");

      form.init();
    },
    prepareFormData: () => {
      const datasetForSubmit = {
        BusinessType: form.config.dataset.BusinessType || "",
        OtherBusinessType: form.config.dataset.OtherBusinessType || "",
        OtherCountry: form.config.dataset.OtherCountry || "",
        SelectedCountries: form.config.dataset.SelectedCountries || "",
        SelectedDateTime: form.config.dataset.SelectedDateTime || "",
        UserAgreementStatus: form.config.dataset.UserAgreementStatus || "N",
        UserEmail: form.config.dataset.UserEmail || "",
        UserSelectedOption: form.config.dataset.UserSelectedOption || "No",
      };
      console.log("this is date and time", datasetForSubmit.SelectedDateTime);

      if (datasetForSubmit.SelectedCountries.includes("Other")) {
        let countriesArray = datasetForSubmit.SelectedCountries.split(",");
        countriesArray = countriesArray.filter(
          (country) => country !== "Other"
        );
        datasetForSubmit.SelectedCountries = countriesArray.join(",");
      }

      return datasetForSubmit;
    },
    populateFormForView: (dataItem) => {
      const modalContent = `
        <div>
          <div id="viewTabs"></div>
        </div>
      `;
      modalHelpers.modalWithCloseBtn("View Details", modalContent, true);

      hpe.ui.tabs(
        {
          dom: document.querySelector("#viewTabs"),
          tabs: [
            {
              label: "Agreement",
              id: "First",
            },
            {
              label: "Company Information",
              id: "Second",
            },
            {
              label: "Select date & country",
              id: "Third",
            },
          ],
        },
        function (all) {
          const firstTab = all[0];
          const secondTab = all[1];
          const thirdTab = all[2];

          Object.assign(viewForm.config.dataset, dataItem);

          firstTab.innerHTML = '<div id="firstTab"></div>';

          viewForm.config.dom = firstTab.querySelector("#firstTab");
          nbsf.init(viewForm.config, 0);

          secondTab.innerHTML = '<div id="secondTab"></div>';
          viewForm.config.dom = secondTab.querySelector("#secondTab");
          nbsf.init(viewForm.config, 1);

          thirdTab.innerHTML = '<div id="thirdTab"></div>';
          viewForm.config.dom = thirdTab.querySelector("#thirdTab");
          nbsf.init(viewForm.config, 2);
        }
      );
    },
  };

  const grid = {
    config: {
      dom: document.querySelector("#main"),
      dataSource: new kendo.data.DataSource({
        type: "rfb-v2",
        transport: {
          read: {
            url: "/form/data-set-provider/v2/1884/Robert_Test/kendo/data/search",
            type: "POST",
          },
          create: {
            url: "/form/data-set-provider/v2/1884/Robert_Test/kendo/data",
            dataType: "json",
            type: "POST",
          },
          update: {
            url: "/form/data-set-provider/v2/1884/Robert_Test/kendo/data",
            dataType: "json",
            type: "PUT",
          },
          destroy: {
            url: "/form/data-set-provider/v2/1884/Robert_Test/kendo/data",
            dataType: "json",
            type: "DELETE",
          },
        },
        schema: {
          model: {
            id: "EntryId",
            fields: {
              EntryId: { type: "number", editable: false },
              Created: { type: "date", editable: false },
              BusinessType: { type: "string" },
              OtherBusinessType: { type: "string" },
              SelectedCountries: { type: "string" },
              OtherCountry: { type: "string" },
              SelectedDateTime: { type: "date" },
            },
          },
        },
        serverPaging: true,
        pageSize: 15,
        serverFiltering: true,
        serverSorting: true,
        size: "small",
        sort: { field: "EntryId", dir: "desc" },
      }),
    },
    init: function () {
      $(this.config.dom).kendoGrid({
        dataSource: this.config.dataSource,
        filterable: true,
        sortable: true,
        editable: "incell",
        resizable: true,
        reorderable: true,
        pageable: {
          refresh: true,
          pageSizes: true,
          buttonCount: 5,
        },
        groupable: true,
        toolbar: [
          {
            name: "addNewRecordBtn",
            text: "Add new record",
            iconClass: "k-icon k-i-add",
            id: "customBtn",
          },
          "excel",
        ],
        excel: {
          fileName: "Kendo UI Grid Export.xlsx",
          proxyURL: "https://demos.telerik.com/kendo-ui/service/export",
          filterable: true,
        },
        columns: [
          { field: "EntryId", title: "EntryId", locked: true, width: "100px" },
          {
            field: "Created",
            title: "Created Date",
            format: "{0:MM/dd/yyyy}",
            locked: true,
            filterable: {
              ui: "datepicker",
            },
            width: "150px",
          },
          {
            field: "BusinessType",
            title: "Company Business Type",
            template: function (dataItem) {
              return dataItem.BusinessType === "Other"
                ? `Other: ${dataItem.OtherBusinessType}`
                : dataItem.BusinessType;
            },
            width: "200px",
          },
          {
            field: "SelectedCountries",
            title: "Countries",
            template: function (dataItem) {
              let countries = dataItem.SelectedCountries;
              if (dataItem.OtherCountry) {
                countries += `, ${dataItem.OtherCountry}`;
              }
              return countries;
            },
            width: "250px",
          },
          {
            field: "SelectedDateTime",
            label: "Datetime",
            format: "{0:MM/dd/yyyy hh:mm tt}",
            width: "200px",
          },
          {
            command: [
              {
                name: "editButton",
                text: "Edit",
                click: function (e) {
                  const dataItem = this.dataItem(
                    $(e.currentTarget).closest("tr")
                  );
                  formActions.populateFormForEdit(dataItem);
                },
              },
              {
                name: "deleteButton",
                text: "Delete",
                click: function (e) {
                  const dataItem = this.dataItem(
                    $(e.currentTarget).closest("tr")
                  );
                  modalHelpers.openDeleteConfirmationModal(dataItem.EntryId);
                },
              },
              {
                name: "view",
                text: "View",
                click: function (e) {
                  const dataItem = this.dataItem(
                    $(e.currentTarget).closest("tr")
                  );
                  formActions.populateFormForView(dataItem);
                },
              },
            ],
            title: "&nbsp;",
            width: "300px",
          },
        ],
        editable: "false",
        save: function (e) {
          dataSource.read();
        },
        dataBound: function () {
          $("a.k-grid-addNewRecordBtn").on("click", function (e) {
            form.config.dataset = {};
            currentEntryId = null;
            utils.clickTab("Form");
          });
        },
      });
    },
  };

  const form = {
    config: {
      page: 0,
      dom: document.querySelector("#main"),
      dataset: {},
      pages: [
        // Page 1: Agreement
        {
          title: "Agreement",
          subtitle: "",
          description: "",
          nav: true,
          structure: [
            {
              header: "",
              description: "",
              group: [
                [
                  {
                    label: "Agreement Confirmed",
                    data: "UserAgreementStatus",
                    required: true,
                    type: "toggle",
                    values: ["N", "Y"],
                    disabled: false,
                  },
                ],
              ],
            },
            {
              header: "",
              description: "",
              group: [
                [
                  {
                    label: "Email:",
                    data: "UserEmail",
                    type: "email",
                    placeholder: "Please input email address",
                    validation: ["isEmail"],
                    required: true,
                    disabled: false,
                  },
                ],
              ],
            },
          ],
        },
        // Page 2: Company Information
        {
          title: "Company Information",
          subtitle: "",
          description: "",
          nav: true,
          structure: [
            {
              header: "",
              description: "",
              group: [
                [
                  {
                    type: "select",
                    data: "BusinessType",
                    label: "Company Business Type",
                    values: ["Distributor", "Reseller", "Provider", "Other"],
                    options: ["Distributor", "Reseller", "Provider", "Other"],
                    required: true,
                    disabled: false,
                    change: formActions.handleBusinessTypeChange,
                  },

                  {
                    type: "text",
                    data: "OtherBusinessType",
                    label: "Please specify if Other",
                    validation: ["minLen|1"],
                    disabled: false,
                  },
                ],
                [
                  {
                    type: "radio",
                    data: "UserSelectedOption",
                    label: "Choose",
                    values: ["Yes", "No"],
                    required: true,
                    disabled: false,
                  },
                ],
              ],
            },
          ],
          callback: formActions.handleBusinessTypeChange,
        },
        // Page 3: Date & Country Selection
        {
          title: "Select date & country",
          substitle: "",
          description: "",
          nav: true,
          structure: [
            {
              header: "",
              description: "",
              group: [
                [
                  {
                    type: "datetime",
                    data: "SelectedDateTime",
                    label: "Datetime",
                    placeholder: "Select a date",
                    required: true,
                    disabled: false,
                  },
                ],
                [
                  {
                    type: "multiselect",
                    data: "SelectedCountries",
                    label: "Select Countries",
                    values: [
                      "USA",
                      "Canada",
                      "Germany",
                      "France",
                      "Japan",
                      "India",
                      "China",
                      "Brazil",
                      "Australia",
                      "Mexico",
                      "Other",
                    ],
                    required: true,
                    disabled: false,
                    change: formActions.handleCountriesChange,
                  },
                  {
                    type: "text",
                    data: "OtherCountry",
                    label: "Please specify if Other",
                    validation: ["minLen|1"],
                    disabled: false,
                  },
                ],
              ],
            },
          ],
          callback: formActions.handleCountriesChange,
        },
      ],
      onSubmit: formActions.submitForm,
    },
    init: function () {
      nbsf.init(this.config, this.config.page);
    },
  };

  const viewForm = {
    config: {
      page: 0,
      dom: document.querySelector("#main"),
      dataset: {},
      pages: [
        // Page 1: Agreement
        {
          title: "Agreement",
          subtitle: "",
          description: "",
          nav: false,
          structure: [
            {
              header: "",
              description: "",
              group: [
                [
                  {
                    label: "Agreement Confirmed",
                    data: "UserAgreementStatus",
                    required: true,
                    type: "toggle",
                    values: ["N", "Y"],
                    disabled: true,
                  },
                ],
              ],
            },
            {
              header: "",
              description: "",
              group: [
                [
                  {
                    label: "Email:",
                    data: "UserEmail",
                    type: "email",
                    placeholder: "Please input email address",
                    validation: ["isEmail"],
                    required: true,
                    disabled: true,
                  },
                ],
              ],
            },
          ],
        },
        // Page 2: Company Information
        {
          title: "Company Information",
          subtitle: "",
          description: "",
          nav: false,
          structure: [
            {
              header: "",
              description: "",
              group: [
                [
                  {
                    type: "select",
                    data: "BusinessType",
                    label: "Company Business Type",
                    values: ["Distributor", "Reseller", "Provider", "Other"],
                    options: ["Distributor", "Reseller", "Provider", "Other"],
                    required: true,
                    disabled: true,
                    change: formActions.handleBusinessTypeChange,
                  },

                  {
                    type: "text",
                    data: "OtherBusinessType",
                    label: "Please specify if Other",
                    validation: ["minLen|1"],
                    disabled: true,
                  },
                ],
                [
                  {
                    type: "radio",
                    data: "UserSelectedOption",
                    label: "Choose",
                    values: ["Yes", "No"],
                    required: true,
                    disabled: true,
                  },
                ],
              ],
            },
          ],
          callback: formActions.handleBusinessTypeChange,
        },
        // Page 3: Date & Country Selection
        {
          title: "Select date & country",
          substitle: "",
          description: "",
          nav: false,
          structure: [
            {
              header: "",
              description: "",
              group: [
                [
                  {
                    type: "datetime",
                    data: "SelectedDateTime",
                    label: "Datetime",
                    placeholder: "Select a date",
                    required: true,
                    disabled: true,
                  },
                ],
                [
                  {
                    type: "multiselect",
                    data: "SelectedCountries",
                    label: "Select Countries",
                    values: [
                      "USA",
                      "Canada",
                      "Germany",
                      "France",
                      "Japan",
                      "India",
                      "China",
                      "Brazil",
                      "Australia",
                      "Mexico",
                      "Other",
                    ],
                    required: true,
                    disabled: true,
                    change: formActions.handleCountriesChange,
                  },
                  {
                    type: "text",
                    data: "OtherCountry",
                    label: "Please specify if Other",
                    validation: ["minLen|1"],
                    disabled: true,
                  },
                ],
              ],
            },
          ],
          callback: formActions.handleCountriesChange,
        },
      ],
      onSubmit: formActions.submitForm,
    },
    init: function () {
      nbsf.init(this.config, this.config.page);
    },
  };

  const formContainer = {
    config: {},
    init: function () {
      hpe.ui.tabs(
        {
          dom: document.querySelector("#main"),
          tabs: [
            {
              label: "Grid",
              id: "Grid",
            },
            {
              label: "Form",
              id: "Form",
            },
          ],
        },
        function (all) {
          const gridTab = all[0];
          const formTab = all[1];

          formTab.innerHTML = '<div id="formTab"></div>';
          form.config.dom = formTab.querySelector("#formTab");
          form.init();

          gridTab.innerHTML = '<div id="gridTab"></div>';
          grid.config.dom = gridTab.querySelector("#gridTab");
          grid.init();
        }
      );
    },
  };

  const main = {
    init: function () {
      hpe.supplies.crud();
      hpe.supplies.mojs();
      hpe.supplies.nbsf();
      hpe.supplies.q.end(function () {
        mo.init();
        formContainer.init();
      });
    },
  };

  main.init();
</script>
